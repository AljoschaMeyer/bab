<!doctype html><html><head><meta charset="utf-8" /><title>Bab</title><link href="assets/index.css" rel="stylesheet" /><script src="assets/toc.js" defer></script><script src="assets/pretty_previews.js" type="module" defer></script><script src="assets/defs.js" type="module" defer></script><link href="assets/pseudocode.css" rel="stylesheet" /><script src="assets/pseudocode.js" type="module" defer></script><link href="assets/katex.min.css" rel="stylesheet" /><meta name="viewport" content="width=device-width, initial-scale=1"><script>
    /*to prevent Firefox FOUC, this must be here*/
    let FF_FOUC_FIX;
  </script></head><body><div id="wrapContent"><h1 id="title"><a class="hsection" data-ref="title" data-hl="true" data-hsection-level="0" href="#title">Bab</a></h1><section data-hsection="title"><ol class="toc onlyLeft"><li data-hsection="introduction" data-hlevel="1"><a class="hsection" data-hsection-level="1" data-ref="introduction" data-hl="true" href="#introduction">Introduction</a><ol></ol></li><li data-hsection="the_function" data-hlevel="1"><a class="hsection" data-hsection-level="1" data-ref="the_function" data-hl="true" href="#the_function">The Bab Hash Function</a><ol><li data-hsection="parameters" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="parameters" data-hl="true" href="#parameters">Parameters</a><ol></ol></li><li data-hsection="tree" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="tree" data-hl="true" href="#tree">The Merkle Tree</a><ol></ol></li><li data-hsection="instantiations" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="instantiations" data-hl="true" href="#instantiations">Instantiations</a><ol><li data-hsection="instantiations_from_secure" data-hlevel="3"><a class="hsection" data-hsection-level="3" data-ref="instantiations_from_secure" data-hl="true" href="#instantiations_from_secure">Via Conventional Hash Function</a><ol></ol></li><li data-hsection="instantiations_william" data-hlevel="3"><a class="hsection" data-hsection-level="3" data-ref="instantiations_william" data-hl="true" href="#instantiations_william">William3</a><ol></ol></li></ol></li></ol></li><li data-hsection="requests" data-hlevel="1"><a class="hsection" data-hsection-level="1" data-ref="requests" data-hl="true" href="#requests">Requests and Verifiable Responses</a><ol><li data-hsection="sec_batch_get" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_batch_get" data-hl="true" href="#sec_batch_get">Batch Get Requests</a><ol></ol></li><li data-hsection="sec_length" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_length" data-hl="true" href="#sec_length">Length Requests</a><ol></ol></li><li data-hsection="sec_simple_streaming" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_simple_streaming" data-hl="true" href="#sec_simple_streaming">Simple Get Requests</a><ol></ol></li><li data-hsection="sec_dynamic_streaming" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_dynamic_streaming" data-hl="true" href="#sec_dynamic_streaming">Dynamic Get Requests</a><ol></ol></li><li data-hsection="sec_static_streaming" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_static_streaming" data-hl="true" href="#sec_static_streaming">Static Get Requests</a><ol></ol></li><li data-hsection="sec_simple_slice" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_simple_slice" data-hl="true" href="#sec_simple_slice">Simple Slice Requests</a><ol></ol></li><li data-hsection="sec_pruned_slice" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_pruned_slice" data-hl="true" href="#sec_pruned_slice">Pruned Slice Requests</a><ol></ol></li><li data-hsection="sec_dynamic_slice" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_dynamic_slice" data-hl="true" href="#sec_dynamic_slice">Dynamic Pruned Slice Requests</a><ol></ol></li><li data-hsection="sec_static_slice" data-hlevel="2"><a class="hsection" data-hsection-level="2" data-ref="sec_static_slice" data-hl="true" href="#sec_static_slice">Static Pruned Slice Requests</a><ol></ol></li></ol></li><li data-hsection="bibliography" data-hlevel="1"><a class="hsection" data-hsection-level="1" data-ref="bibliography" data-hl="true" href="#bibliography">References</a><ol></ol></li></ol><div><div class="authors"><div class="author"><div class="authorName"><a href="https://aljoscha-meyer.de/">Aljoscha Meyer</a></div><div class="authorEmail"><a href="mailto:research@aljoscha-meyer.de">research@aljoscha-meyer.de</a></div></div></div></div><div><section class="abstract"><p>Bab is a <a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">secure hash function</a> heavily inspired by Blake3, designed for use in peer-to-peer content-addressed storage systems.</p></section></div><h2 id="introduction"><a class="hsection" data-ref="introduction" data-hl="true" data-hsection-level="1" href="#introduction">1 Introduction</a></h2><section data-hsection="introduction"><p><a href="https://en.wikipedia.org/wiki/Content-addressable_storage">Content-addressable storage</a> lets users refer to strings (files) by a secure hash. Bab is a specification for a hash function specifically designed for usage in peer-to-peer content-addressable storage systems.</p><p>The key feature of Bab is that it allows holders of a string to authenticate any substring as occuring in the original string. Content-addressed storage systems without this feature face a problem in byzanthine environments. Suppose a client requests the string corresponding to some hash. The server replies with some data, but the connection is interrupted before the full string was transfered. What should the client do?</p><p>It could store the data it received, and later it could issue a request for the same string, resuming at the correct offset. But that request will fail if the orginal server fed it garbage, and the client will be unable to tell which of its two communication partners acted maliciously. Also, the server might have sent it data that is illegal to store. Hence, a careful client should discard all incomplete data it received. But this makes it highly unlike to successfully transfer large strings over an unreliable network.</p><p>When strings are hashed with Bab, servers embed into the data stream efficiently verifiable proofs that the data they have sent so far is indeed part of the requested string. More specifically, Bab enables the following features (all of which will be explained in detail in <a class="hsection" data-hsection-level="1" data-ref="requests" data-hl="true" href="#requests">Section&nbsp;3</a>):</p><ul><li>secure content-addressing,</li><li>incremental verification of streaming string data,</li><li>efficient verification of arbitrary subslices within a string, and</li><li>constant-size length proofs for strings.<span class="marginale">While we explore Bab in the context of hashing, you can also think of it as an <a class="bib" data-ref="tamassia2003authenticated" data-preview-anchor="previews/tamassia2003authenticated.html?def§tamassia2003authenticated" href="assets/references/tamassia2003authenticated.pdf"><span class="bibText">authenticated data structure</span>&nbsp;<span class="bibCitation">(<span style="font-variant:small-caps;">Tamassia</span>, 2003)</span></a> for arrays.</span></li></ul><p>Bab employs many of the same techniques as the <a href="https://github.com/BLAKE3-team/BLAKE3-specs/blob/master/blake3.pdf">Blake3</a>-based <a href="https://github.com/oconnor663/bao/blob/master/docs/spec.md">Bao</a> spec. Key differences are short proofs of string length, more efficient slice requests, and a hash-function-agnostic specification. Bao is a byproduct of a well-designed general-purpose hash function, whereas Bab is a special-purpose hash function that gets to add features beyond Bao’s capabilities.</p></section><h2 id="the_function"><a class="hsection" data-ref="the_function" data-hl="true" data-hsection-level="1" href="#the_function">2 The Bab Hash Function</a></h2><section data-hsection="the_function"><p>Like Blake3, Bab hashes an input string by splitting it into chunks, arranging the chunks as the roots of a <a href="https://en.wikipedia.org/wiki/Binary_tree">binary</a>, <a href="https://en.wikipedia.org/wiki/Binary_tree#complete">left-full</a> <a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle-tree</a>; the label of the root becomes the digest of the input.</p><h3 id="parameters"><a class="hsection" data-ref="parameters" data-hl="true" data-hsection-level="2" href="#parameters">2.1 Parameters</a></h3><section data-hsection="parameters"><p>Bab leaves open some paramters, they need to be given as “input” to the Bab specification. We now list the precise parameters of a Bab instantiation.</p><p>The <dfn id="chunk_size"><a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a></dfn> value must be a natural number greater than zero. Given an input bytestring <dfn id="in"><a class="rustic value" data-ref="in" data-preview-anchor="/bab/previews/in.html?def§in" data-hl="true" href="#in">in</a></dfn> of at most <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> bytes, Bab splits it into a non-empty sequence <dfn id="chunks"><a class="rustic value" data-ref="chunks" data-preview-anchor="/bab/previews/chunks.html?def§chunks" data-hl="true" href="#chunks">chunks</a></dfn> of <dfn id="chunk"><a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunks</a></dfn>: the first <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> bytes become the first <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a>, the next <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> bytes become the second <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a>, and so on. Only the final <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a> may be shorter than <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a>. For example, splitting the ASCII string <code>hello_world</code> with a <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> of <code>2</code> yields the <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunks</a> <code>he</code>, <code>ll</code>, <code>o_</code>, <code>wo</code>, <code>rl</code>, and <code>d</code>. If <a class="rustic value" data-ref="in" data-preview-anchor="/bab/previews/in.html?def§in" data-hl="true" href="#in">in</a> is the empty string, then <a class="rustic value" data-ref="chunks" data-preview-anchor="/bab/previews/chunks.html?def§chunks" data-hl="true" href="#chunks">chunks</a> consists of a single, empty <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a>.</p><p>The <dfn id="width"><a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a></dfn> value must be a natural number greater than zero. Bab maps input bytestrings (of at most <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> bytes) to digests of <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> many bytes.</p><p>The <dfn id="hash_chunk"><a class="rustic function" data-ref="hash_chunk" data-preview-anchor="/bab/previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a></dfn> function determines the labels of the leaf nodes of Bab’s Merkle-tree. It must be a function that maps a triplet of a <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a>, a chunk index (a natural number between zero and <code>ceil(<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a>)</code>), and a boolean flag (whether the node is the root node or not) to bytestrings of <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> bytes.</p><p>The <dfn id="hash_inner"><a class="rustic function" data-ref="hash_inner" data-preview-anchor="/bab/previews/hash_inner.html?def§hash_inner" data-hl="true" href="#hash_inner">hash_inner</a></dfn> function determines the labels of the inner nodes of Bab’s Merkle-tree. It must be a function that maps a quadruplet of two bytestrings of <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> bytes (the labels of the two child nodes), an unsigned 64-bit integer (the length of the input substring covered by the node), and a boolean flag (whether the node is the root node or not) to bytestrings of <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> bytes.</p></section><h3 id="tree"><a class="hsection" data-ref="tree" data-hl="true" data-hsection-level="2" href="#tree">2.2 The Merkle Tree</a></h3><section data-hsection="tree"><p>To hash a bytestring <a class="rustic value" data-ref="in" data-preview-anchor="previews/in.html?def§in" data-hl="true" href="#in">in</a> that was split into a <a data-ref="chunk" data-preview-anchor="previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a> sequence <a class="rustic value" data-ref="chunks" data-preview-anchor="previews/chunks.html?def§chunks" data-hl="true" href="#chunks">chunks</a>, Bab constructs a <a href="https://en.wikipedia.org/wiki/Binary_tree#complete">left-full</a> <a href="https://en.wikipedia.org/wiki/Binary_tree">binary</a> tree with one leaf per <a data-ref="chunk" data-preview-anchor="previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a>; we number the vertices in <a href="https://en.wikipedia.org/wiki/Tree_traversal#Breadth-first_search">depth-first</a> order, prioritizing left children over right children, starting at <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> in the root. <a class="figure" data-ref="fig_tree_unlabeled" data-preview-anchor="previews/fig_tree_unlabeled.html?def§fig_tree_unlabeled" href="#fig_tree_unlabeled">Figure&nbsp;1</a> shows an example.</p><figure id="fig_tree_unlabeled"><img alt="A left-full binary tree, the result of giving the input string *hello_world*." src="/bab/assets/graphics/tree_unlabeled.svg" /><figcaption><p><a class="figure" data-ref="fig_tree_unlabeled" data-preview-anchor="/bab/previews/fig_tree_unlabeled.html?def§fig_tree_unlabeled" href="#fig_tree_unlabeled">Figure&nbsp;1</a>: Unlabeled Example Tree</p><p>The (unlabeled) binary tree for the input string <code>hello_world</code> with a <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> of <code>2</code>.</p></figcaption></figure><p>Bab assigns to each vertex <dfn id="lblv"><a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a></dfn> a label <dfn id="lbl"><a class="rustic function" data-ref="lbl" data-preview-anchor="/bab/previews/lbl.html?def§lbl" data-hl="true" href="#lbl">lbl</a></dfn><span class="rb1 open">(</span><a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a><span class="rb1 close">)</span>; the root label serves as the <dfn id="digest"><a class="rustic value" data-ref="digest" data-preview-anchor="/bab/previews/digest.html?def§digest" data-hl="true" href="#digest">digest</a></dfn> of <a class="rustic value" data-ref="in" data-preview-anchor="/bab/previews/in.html?def§in" data-hl="true" href="#in">in</a>.</p><p>If <a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a> is a leaf vertex corresponding to the <dfn id="lbl_leaf_i"><a class="rustic value" data-ref="lbl_leaf_i" data-preview-anchor="/bab/previews/lbl_leaf_i.html?def§lbl_leaf_i" data-hl="true" href="#lbl_leaf_i">i</a></dfn>-th <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a> (zero-indexed) <dfn id="lbl_leaf_c"><a class="rustic value" data-ref="lbl_leaf_c" data-preview-anchor="/bab/previews/lbl_leaf_c.html?def§lbl_leaf_c" data-hl="true" href="#lbl_leaf_c">c</a></dfn>, then <a class="rustic function" data-ref="lbl" data-preview-anchor="/bab/previews/lbl.html?def§lbl" data-hl="true" href="#lbl">lbl</a><span class="rb1 open">(</span><a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a><span class="rb1 close">)</span> is <a class="rustic function" data-ref="hash_chunk" data-preview-anchor="/bab/previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a><span class="rb1 open">(</span><a class="rustic value" data-ref="lbl_leaf_c" data-preview-anchor="/bab/previews/lbl_leaf_c.html?def§lbl_leaf_c" data-hl="true" href="#lbl_leaf_c">c</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbl_leaf_i" data-preview-anchor="/bab/previews/lbl_leaf_i.html?def§lbl_leaf_i" data-hl="true" href="#lbl_leaf_i">i</a><span class="deemph">,</span> true<span class="rb1 close">)</span> if <a class="rustic value" data-ref="lbl_leaf_c" data-preview-anchor="/bab/previews/lbl_leaf_c.html?def§lbl_leaf_c" data-hl="true" href="#lbl_leaf_c">c</a> is the <em>only</em> <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunk</a> in <a class="rustic value" data-ref="chunks" data-preview-anchor="/bab/previews/chunks.html?def§chunks" data-hl="true" href="#chunks">chunks</a>, and <a class="rustic function" data-ref="hash_chunk" data-preview-anchor="/bab/previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a><span class="rb1 open">(</span><a class="rustic value" data-ref="lbl_leaf_c" data-preview-anchor="/bab/previews/lbl_leaf_c.html?def§lbl_leaf_c" data-hl="true" href="#lbl_leaf_c">c</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbl_leaf_i" data-preview-anchor="/bab/previews/lbl_leaf_i.html?def§lbl_leaf_i" data-hl="true" href="#lbl_leaf_i">i</a><span class="deemph">,</span> false<span class="rb1 close">)</span>, otherwise.</p><p>If <a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a> is an inner vertex, let <dfn id="lbl_inner_l"><a class="rustic value" data-ref="lbl_inner_l" data-preview-anchor="/bab/previews/lbl_inner_l.html?def§lbl_inner_l" data-hl="true" href="#lbl_inner_l">left</a></dfn> denote its left child, let <dfn id="lbl_inner_r"><a class="rustic value" data-ref="lbl_inner_r" data-preview-anchor="/bab/previews/lbl_inner_r.html?def§lbl_inner_r" data-hl="true" href="#lbl_inner_r">right</a></dfn> denote its right child, let <dfn id="lbl_inner_len"><a class="rustic value" data-ref="lbl_inner_len" data-preview-anchor="/bab/previews/lbl_inner_len.html?def§lbl_inner_len" data-hl="true" href="#lbl_inner_len">len</a></dfn> denote the total length of the <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunks</a> corresponding to all leaf descendents of <a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a>, and let <dfn id="lbl_inner_is_root"><a class="rustic value" data-ref="lbl_inner_is_root" data-preview-anchor="/bab/previews/lbl_inner_is_root.html?def§lbl_inner_is_root" data-hl="true" href="#lbl_inner_is_root">is_root</a></dfn> be <code>true</code> if and only if <a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a> is the root of the tree. Then <a class="rustic function" data-ref="lbl" data-preview-anchor="/bab/previews/lbl.html?def§lbl" data-hl="true" href="#lbl">lbl</a><span class="rb1 open">(</span><a class="rustic value" data-ref="lblv" data-preview-anchor="/bab/previews/lblv.html?def§lblv" data-hl="true" href="#lblv">v</a><span class="rb1 close">)</span> is <a class="rustic function" data-ref="hash_inner" data-preview-anchor="/bab/previews/hash_inner.html?def§hash_inner" data-hl="true" href="#hash_inner">hash_inner</a><span class="rb1 open">(</span><a class="rustic value" data-ref="lbl_inner_l" data-preview-anchor="/bab/previews/lbl_inner_l.html?def§lbl_inner_l" data-hl="true" href="#lbl_inner_l">left</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbl_inner_r" data-preview-anchor="/bab/previews/lbl_inner_r.html?def§lbl_inner_r" data-hl="true" href="#lbl_inner_r">right</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbl_inner_len" data-preview-anchor="/bab/previews/lbl_inner_len.html?def§lbl_inner_len" data-hl="true" href="#lbl_inner_len">len</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbl_inner_is_root" data-preview-anchor="/bab/previews/lbl_inner_is_root.html?def§lbl_inner_is_root" data-hl="true" href="#lbl_inner_is_root">is_root</a><span class="rb1 close">)</span>.</p><p><a href="#">invalid-reference</a> gives an example of a labeled Merkle-tree:</p></section><h3 id="instantiations"><a class="hsection" data-ref="instantiations" data-hl="true" data-hsection-level="2" href="#instantiations">2.3 Instantiations</a></h3><section data-hsection="instantiations"><p>The choice of parameters for using Bab is open, but some care needs to be taken to create a secure (i.e., collision-resistant and preimage-resistant) hash function. <a class="rustic function" data-ref="hash_chunk" data-preview-anchor="previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a> and <a class="rustic function" data-ref="hash_inner" data-preview-anchor="previews/hash_inner.html?def§hash_inner" data-hl="true" href="#hash_inner">hash_inner</a> must be secure hash functions themselves, and it must further be impossible to find an input to <a class="rustic function" data-ref="hash_chunk" data-preview-anchor="previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a> and one to <a class="rustic function" data-ref="hash_inner" data-preview-anchor="previews/hash_inner.html?def§hash_inner" data-hl="true" href="#hash_inner">hash_inner</a> such that both yield the same digest.</p><p>We supply two useful instantiations: one based on arbitrary secure hash functions, and a more efficient one that closely mimics Blake3.</p><h4 id="instantiations_from_secure"><a class="hsection" data-ref="instantiations_from_secure" data-hl="true" data-hsection-level="3" href="#instantiations_from_secure">2.3.1 Via Conventional Hash Function</a></h4><section data-hsection="instantiations_from_secure"><p>Given a conventional, secure hash function <dfn id="conv_h"><a class="rustic function" data-ref="conv_h" data-preview-anchor="/bab/previews/conv_h.html?def§conv_h" data-hl="true" href="#conv_h">h</a></dfn> of digest size <dfn id="conv_width"><a class="rustic value" data-ref="conv_width" data-preview-anchor="/bab/previews/conv_width.html?def§conv_width" data-hl="true" href="#conv_width">w</a></dfn>, we can instantiate Bab for a <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> of <a class="rustic value" data-ref="conv_width" data-preview-anchor="/bab/previews/conv_width.html?def§conv_width" data-hl="true" href="#conv_width">w</a> and an arbitrary <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a>.</p><p>Define <a class="rustic function" data-ref="hash_chunk" data-preview-anchor="/bab/previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a><span class="rb1 open">(</span><dfn id="conv_chunk_chunk"><a class="rustic value" data-ref="conv_chunk_chunk" data-preview-anchor="/bab/previews/conv_chunk_chunk.html?def§conv_chunk_chunk" data-hl="true" href="#conv_chunk_chunk">chunk</a></dfn><span class="deemph">,</span> <dfn id="conv_chunk_i"><a class="rustic value" data-ref="conv_chunk_i" data-preview-anchor="/bab/previews/conv_chunk_i.html?def§conv_chunk_i" data-hl="true" href="#conv_chunk_i">index</a></dfn><span class="deemph">,</span> <dfn id="conv_chunk_root"><a class="rustic value" data-ref="conv_chunk_root" data-preview-anchor="/bab/previews/conv_chunk_root.html?def§conv_chunk_root" data-hl="true" href="#conv_chunk_root">is_root</a></dfn><span class="rb1 close">)</span> as applying <a class="rustic function" data-ref="conv_h" data-preview-anchor="/bab/previews/conv_h.html?def§conv_h" data-hl="true" href="#conv_h">h</a> to the concatenation of<ul><li>the byte <code>0x00</code> if <a class="rustic value" data-ref="conv_chunk_root" data-preview-anchor="/bab/previews/conv_chunk_root.html?def§conv_chunk_root" data-hl="true" href="#conv_chunk_root">is_root</a> is <code>false</code>, or the byte <code>0x01</code> otherwise,</li><li><a class="rustic value" data-ref="conv_chunk_i" data-preview-anchor="/bab/previews/conv_chunk_i.html?def§conv_chunk_i" data-hl="true" href="#conv_chunk_i">index</a> encoded as an unsigned big-endian 64-bit integer, and</li><li><a class="rustic value" data-ref="conv_chunk_chunk" data-preview-anchor="/bab/previews/conv_chunk_chunk.html?def§conv_chunk_chunk" data-hl="true" href="#conv_chunk_chunk">chunk</a>.</li></ul></p><p>Define <a class="rustic function" data-ref="hash_inner" data-preview-anchor="/bab/previews/hash_inner.html?def§hash_inner" data-hl="true" href="#hash_inner">hash_inner</a><span class="rb1 open">(</span><dfn id="conv_inner_l"><a class="rustic value" data-ref="conv_inner_l" data-preview-anchor="/bab/previews/conv_inner_l.html?def§conv_inner_l" data-hl="true" href="#conv_inner_l">left</a></dfn><span class="deemph">,</span> <dfn id="conv_inner_r"><a class="rustic value" data-ref="conv_inner_r" data-preview-anchor="/bab/previews/conv_inner_r.html?def§conv_inner_r" data-hl="true" href="#conv_inner_r">right</a></dfn><span class="deemph">,</span> <dfn id="conv_inner_len"><a class="rustic value" data-ref="conv_inner_len" data-preview-anchor="/bab/previews/conv_inner_len.html?def§conv_inner_len" data-hl="true" href="#conv_inner_len">len</a></dfn><span class="deemph">,</span> <dfn id="conv_inner_root"><a class="rustic value" data-ref="conv_inner_root" data-preview-anchor="/bab/previews/conv_inner_root.html?def§conv_inner_root" data-hl="true" href="#conv_inner_root">is_root</a></dfn><span class="rb1 close">)</span> as applying <a class="rustic function" data-ref="conv_h" data-preview-anchor="/bab/previews/conv_h.html?def§conv_h" data-hl="true" href="#conv_h">h</a> to the concatenation of<ul><li>the byte <code>0x02</code> if <a class="rustic value" data-ref="conv_inner_root" data-preview-anchor="/bab/previews/conv_inner_root.html?def§conv_inner_root" data-hl="true" href="#conv_inner_root">is_root</a> is <code>false</code>, or the byte <code>0x03</code> otherwise,</li><li><a class="rustic value" data-ref="conv_inner_len" data-preview-anchor="/bab/previews/conv_inner_len.html?def§conv_inner_len" data-hl="true" href="#conv_inner_len">len</a> encoded as an unsigned big-endian 64-bit integer,</li><li><a class="rustic value" data-ref="conv_inner_l" data-preview-anchor="/bab/previews/conv_inner_l.html?def§conv_inner_l" data-hl="true" href="#conv_inner_l">left</a>, and</li><li><a class="rustic value" data-ref="conv_inner_r" data-preview-anchor="/bab/previews/conv_inner_r.html?def§conv_inner_r" data-hl="true" href="#conv_inner_r">right</a>.</li></ul></p></section><h4 id="instantiations_william"><a class="hsection" data-ref="instantiations_william" data-hl="true" data-hsection-level="3" href="#instantiations_william">2.3.2 William3</a></h4><section data-hsection="instantiations_william"><p><dfn id="william3"><a class="rustic function" data-ref="william3" data-preview-anchor="/bab/previews/william3.html?def§william3" data-hl="true" href="#william3">William3</a></dfn> is a Bab instantiation that is almost dentical to Blake3. The only difference is that <a class="rustic function" data-ref="william3" data-preview-anchor="/bab/previews/william3.html?def§william3" data-hl="true" href="#william3">William3</a> incorporates a length value into the label computation of inner tree vertices. <a class="rustic function" data-ref="william3" data-preview-anchor="/bab/previews/william3.html?def§william3" data-hl="true" href="#william3">William3</a> has a normal hash mode and a keyed hash mode (based on a 256 bit key); unlike Blake3 it does not support a key derivation mode.</p><p><a class="rustic function" data-ref="william3" data-preview-anchor="/bab/previews/william3.html?def§william3" data-hl="true" href="#william3">William3</a> uses a <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> of 1024 bytes (just like Blake3). Its <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> is 32 bytes (just like Blake3). The <a class="rustic function" data-ref="hash_chunk" data-preview-anchor="/bab/previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a> function is identical to the Blake3 computation of <em>chunk chaining values</em>. The <a class="rustic function" data-ref="hash_inner" data-preview-anchor="/bab/previews/hash_inner.html?def§hash_inner" data-hl="true" href="#hash_inner">hash_inner</a> function is almost identical to the Blake3 computation of <em>parent node chaining values</em>, with a single exception: whereas Blake3 sets the <code>t</code> parameter of its compression function to 0, <a class="rustic function" data-ref="william3" data-preview-anchor="/bab/previews/william3.html?def§william3" data-hl="true" href="#william3">William3</a> sets <code>t</code> to the third argument (the length value) of <a class="rustic function" data-ref="hash_chunk" data-preview-anchor="/bab/previews/hash_chunk.html?def§hash_chunk" data-hl="true" href="#hash_chunk">hash_chunk</a> (as an unsigned <em>little</em>-endian 64-bit integer).</p></section></section></section><h2 id="requests"><a class="hsection" data-ref="requests" data-hl="true" data-hsection-level="1" href="#requests">3 Requests and Verifiable Responses</a></h2><section data-hsection="requests"><p>We now describe the various requests that a client in a Bao-based content-addressable storage system can issue and for which a server can supply verifiable responses.</p><h3 id="sec_batch_get"><a class="hsection" data-ref="sec_batch_get" data-hl="true" data-hsection-level="2" href="#sec_batch_get">3.1 Batch Get Requests</a></h3><section data-hsection="sec_batch_get"><p>A <dfn id="batch_get"><a class="rustic type" data-ref="batch_get" data-preview-anchor="/bab/previews/batch_get.html?def§batch_get" data-hl="true" href="#batch_get">BatchGet</a></dfn> request consists of a single Bab digest, and asks for a string that hashes to that digest. The server can issue two valid responses: either a reply to indicate that the server does not have a corresponding string, or the full string. The client can verify a succesful response by hashing the received string and asserting that it hashes to the original digest.</p><p><a class="rustic type" data-ref="batch_get" data-preview-anchor="previews/batch_get.html?def§batch_get" data-hl="true" href="#batch_get">BatchGet</a> requests are not specific to Bab, they work with arbitrary secure hash functions. The problem is that any partial response is worthless, since the client cannot verify any data. <a class="rustic type" data-ref="batch_get" data-preview-anchor="previews/batch_get.html?def§batch_get" data-hl="true" href="#batch_get">BatchGet</a> requests are notable for their efficiency, however: the response includes no verification metadata. We will later develop a <a class="hsection" data-hsection-level="2" data-ref="sec_dynamic_streaming" data-hl="true" href="#sec_dynamic_streaming">request type</a> that lets clients specify how much untrusted data they are willing to buffer; for sufficiently large buffer capacity, such requests become equivalent to <a class="rustic type" data-ref="batch_get" data-preview-anchor="previews/batch_get.html?def§batch_get" data-hl="true" href="#batch_get">BatchGet</a> requests.</p></section><h3 id="sec_length"><a class="hsection" data-ref="sec_length" data-hl="true" data-hsection-level="2" href="#sec_length">3.2 Length Requests</a></h3><section data-hsection="sec_length"><p>A <dfn id="length"><a class="rustic type" data-ref="length" data-preview-anchor="/bab/previews/length.html?def§length" data-hl="true" href="#length">Length</a></dfn> request consists of a single Bab digest, and asks for the length of a string that hashes to that digest.<span class="marginale">Bao, unlike Bab, can certify a length only by transmitting the full string.</span> The server can issue two valid responses: either a reply to indicate that the server does not know of a corresponding string, or the length of the string, followed by a length proof. If the length is less than or equal to <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a>, the length proof is simply the string itself, verifiable by the client by hashing the string and asserting that it hashes to the original digest. If the length is greater than <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a>, then the corresponding Merkle tree has an inner vertex as a root. The length proof then consists of the labels of the left and the right child of the root vertex. The client verifies this proof by asserting that <a class="rustic function" data-ref="hash_inner" data-preview-anchor="/bab/previews/hash_inner.html?def§hash_inner" data-hl="true" href="#hash_inner">hash_inner</a><span class="rb1 open">(</span><dfn id="length_left"><a class="rustic value" data-ref="length_left" data-preview-anchor="/bab/previews/length_left.html?def§length_left" data-hl="true" href="#length_left">left</a></dfn><span class="deemph">,</span> <dfn id="length_right"><a class="rustic value" data-ref="length_right" data-preview-anchor="/bab/previews/length_right.html?def§length_right" data-hl="true" href="#length_right">right</a></dfn><span class="deemph">,</span> <dfn id="length_len"><a class="rustic value" data-ref="length_len" data-preview-anchor="/bab/previews/length_len.html?def§length_len" data-hl="true" href="#length_len">len</a></dfn><span class="deemph">,</span> true<span class="rb1 close">)</span> is equal to the original digest.</p></section><h3 id="sec_simple_streaming"><a class="hsection" data-ref="sec_simple_streaming" data-hl="true" data-hsection-level="2" href="#sec_simple_streaming">3.3 Simple Get Requests</a></h3><section data-hsection="sec_simple_streaming"><p>A <dfn id="simple_streaming_get"><a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="/bab/previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a></dfn> request consists of a single Bab digest, and asks for a string that hashes to that digest, as well as interleaved verification metadata that allows verifying that the stream of incoming string data does indeed prefix the requested string.<span class="marginale">A response to a <a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="/bab/previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a> request corresponds to the notion of the <a href="https://github.com/oconnor663/bao/blob/master/docs/spec.md#combined-encoding-format">combined encoding format</a> of Bao.</span></p><p>A successful response consists of the length of the payload in bytes, followed by the result of performing a depth-first traversal of the string’s Merkle tree (visiting left children before right children), and emitting for each inner vertex the label of its left child followed by the label of its right child, and for each leaf vertex emitting the corresponding chunk. The client can verify the response by reconstructing all labels of the Merkle tree and asserting that all labels match the transmitted values — or the original digest, in case of the root.<span class="marginale"><span class="" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj: TODO: add example, also mention buffering of trusted data</span></span></p><p><a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a> requests correctly implement the core feature of Bab — verified streaming. But they do so in a rather naïve way: whenever the label of a left child is emitted, that data is followed almost immediately by enough further data to compute that label from scratch. So why transmit it in the first place? Skipping the label of a left child means that the client needs to buffer the label of the right child without being able to verify it until the left child has been reconstructed. The response to a <a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a> request minimizes the buffering of unverified data. If the client commits to buffering up to a certain amount of unverified data, then we can define a response stream that gets to omit some labels.</p><p>The <a class="rustic value" data-ref="chunk_size" data-preview-anchor="previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> used by <span class="nowrap">Bab<span class="sidenoteCounter">1</span></span><span class="marginale"><span class="sidenoteCounter">1</span>Or <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="enclosing rustic value"><span class="enclosing" data-ref="width" data-preview-anchor="previews/width.html?def§width" data-hl="true"><a href="#width"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></a></span></span><span class="enclosing normalText"><span class="mord text"><span class="mord">,</span></span></span></span></span></span> whichever is greater. Typically, the <a class="rustic value" data-ref="chunk_size" data-preview-anchor="previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> is significantly greater.</span> serves as a lower bound of how much untrusted data peers must already be willing to buffer (because a chunk can only be verified once <em>all</em> of its bytes were received). Hence, it makes sense to allow at least as much buffering of unverified metadata. <a class="rustic function" data-ref="william3" data-preview-anchor="previews/william3.html?def§william3" data-hl="true" href="#william3">William3</a> (and hence also Blake3-based Bao) has a <a class="rustic value" data-ref="chunk_size" data-preview-anchor="previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> of 1024 bytes, and a <a class="rustic value" data-ref="width" data-preview-anchor="previews/width.html?def§width" data-hl="true" href="#width">width</a> of 32 bytes. This means that clients can reconstruct all but one out of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">32</span></span></span></span> left labels without increasing the length of the longest possible sequences of unverified data to buffer. For each of those 32 left labels, the right label must also be transmitted, so the total amount of all verification metadata is reduced to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2484em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span><span class="mbin mtight">+</span><span class="mord mtight">32</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">33</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>. In Bao (or with <a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a> requests for <a class="rustic function" data-ref="william3" data-preview-anchor="previews/william3.html?def§william3" data-hl="true" href="#william3">William3</a>), the overhead of verfication metadata is roughly 3.125%. A more sophisticated response format that skips 31 out of 32 left labels brings the overhead down to roughly 1.611%.</p><p>If a client is willing to buffer even more unverified metadata than just the <a class="rustic value" data-ref="chunk_size" data-preview-anchor="previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a>, then the response can omit some right labels as well. As an intuitive extreme, consider a client willing to buffer a number of unverified bytes equal to the length of the requested string. In that case, the server can omit <em>all</em> verification metadata — the client simply reconstructs all tree labels from the raw chunk data.</p><p>We now give a precise definition of minimal responses to streaming requests from a client that is willing to buffer a particular, fixed amount of unverified bytes. The computations are not immediately obvious, but not terribly complicated either.</p></section><h3 id="sec_dynamic_streaming"><a class="hsection" data-ref="sec_dynamic_streaming" data-hl="true" data-hsection-level="2" href="#sec_dynamic_streaming">3.4 Dynamic Get Requests</a></h3><section data-hsection="sec_dynamic_streaming"><p>A <dfn id="dynamic_streaming_get"><a class="rustic type" data-ref="dynamic_streaming_get" data-preview-anchor="/bab/previews/dynamic_streaming_get.html?def§dynamic_streaming_get" data-hl="true" href="#dynamic_streaming_get">DynamicStreamingGet</a></dfn> request consists of a Bab digest, and a number of bytes of data that the client is willing to buffer<span class="marginale">If the buffer capacity is zero, the <a class="rustic type" data-ref="dynamic_streaming_get" data-preview-anchor="/bab/previews/dynamic_streaming_get.html?def§dynamic_streaming_get" data-hl="true" href="#dynamic_streaming_get">DynamicStreamingGet</a> request is equivalent to a <a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="/bab/previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a> request. If the capacity is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, the <a class="rustic type" data-ref="dynamic_streaming_get" data-preview-anchor="/bab/previews/dynamic_streaming_get.html?def§dynamic_streaming_get" data-hl="true" href="#dynamic_streaming_get">DynamicStreamingGet</a> request is equivalent to a <a class="rustic type" data-ref="batch_get" data-preview-anchor="/bab/previews/batch_get.html?def§batch_get" data-hl="true" href="#batch_get">BatchGet</a> request.</span> without being able to verify them. A successful response stream is similar to the response stream to a <a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="/bab/previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a> request, but with omissions as defined below. The client can verify the response by reconstructing all labels of the Merkle tree and asserting that all labels match the transmitted values — or the original digest, in case of the root.</p><p>We now give a pseudocode function that assigns to every inner vertex of the Merkle tree whether the labels of its left and right children should be emitted into the response stream or not.</p><code class="pseudocode" id="code_include_labels"><div class="locGutter" data-l="1" data-i="0" id="code_include_labelsL1"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="1" href="#code_include_labelsL1">1</a></div><div class="fold"></div></div><div class="locContent"><div></div><div class="lineComment">Call <a class="rustic function" data-ref="include_labels" data-preview-anchor="/bab/previews/include_labels.html?def§include_labels" data-hl="true" href="#include_labels">include_labels</a> with the root of the tree as the first argument and the buffer capacity for unverified data as both the second and third argument. The function then sets <code>include_left_lbl</code> and <code>include_right_lbl</code> fields on <em>each</em> vertex in the tree that indicate which child labels the vertex contributes to the response stream.</div></div><div class="locGutter" data-l="2" data-i="0" id="code_include_labelsL2"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="2" href="#code_include_labelsL2">2</a></div><div class="fold"></div></div><div class="locContent"><div><span class="kw2">fn</span> <dfn id="include_labels"><a class="rustic function" data-ref="include_labels" data-preview-anchor="/bab/previews/include_labels.html?def§include_labels" data-hl="true" href="#include_labels">include_labels</a></dfn><span class="rb1 open">(</span><dfn id="lbls_v"><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a></dfn><span class="deemph">,</span> <dfn id="lbls_av"><a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a></dfn><span class="deemph">,</span> <dfn id="lbls_max"><a class="rustic value" data-ref="lbls_max" data-preview-anchor="/bab/previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a></dfn><span class="rb1 close">)</span> <span class="deemph">-></span> <span class="rb1 open">{</span></div></div><div class="locGutter" data-l="3" data-i="1" id="code_include_labelsL3"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="3" href="#code_include_labelsL3">3</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><span class="kw">if</span> <a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> &gt;= leaves<span class="rb2 open">(</span><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>left<span class="rb2 close">)</span> * <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> + <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> <span class="rb2 open">{</span></div></div><div class="locGutter" data-l="4" data-i="2" id="code_include_labelsL4"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="4" href="#code_include_labelsL4">4</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div><div class="lineComment">We have sufficient available capacity to send all <a data-ref="chunk" data-preview-anchor="/bab/previews/chunk.html?def§chunk" data-hl="true" href="#chunk">chunks</a> of the left subtree without any verification metadata. Mark all vertices in the left subtree as not including their labels, also mark the current left label.</div></div><div class="locGutter" data-l="5" data-i="2" id="code_include_labelsL5"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="5" href="#code_include_labelsL5">5</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div>skip_all_labels<span class="rb0 open">(</span><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>left<span class="rb0 close">)</span></div></div><div class="locGutter" data-l="6" data-i="2" id="code_include_labelsL6"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="6" href="#code_include_labelsL6">6</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>include_left_lbl <span class="deemph">:=</span> false</div></div><div class="locGutter" data-l="7" data-i="2" id="code_include_labelsL7"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="7" href="#code_include_labelsL7">7</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> <span class="deemph">-=</span> leaves<span class="rb0 open">(</span><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>left<span class="rb0 close">)</span> * <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a> + <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a></div></div><div class="locGutter" data-l="8" data-i="2" id="code_include_labelsL8"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="8" href="#code_include_labelsL8">8</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div></div><div class="locGutter" data-l="9" data-i="2" id="code_include_labelsL9"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="9" href="#code_include_labelsL9">9</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div><div class="lineComment">Can we skip our right label as well?</div></div><div class="locGutter" data-l="10" data-i="2" id="code_include_labelsL10"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="10" href="#code_include_labelsL10">10</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><span class="kw">if</span> <a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> &gt;= <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> <span class="rb0 open">{</span></div></div><div class="locGutter" data-l="11" data-i="3" id="code_include_labelsL11"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="11" href="#code_include_labelsL11">11</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>include_right_lbl <span class="deemph">:=</span> false</div></div><div class="locGutter" data-l="12" data-i="3" id="code_include_labelsL12"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="12" href="#code_include_labelsL12">12</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> <span class="deemph">-=</span> <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a></div></div><div class="locGutter" data-l="13" data-i="2" id="code_include_labelsL13"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="13" href="#code_include_labelsL13">13</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><span class="rb0 close">}</span> <span class="kw">else</span> <span class="rb0 open">{</span></div></div><div class="locGutter" data-l="14" data-i="3" id="code_include_labelsL14"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="14" href="#code_include_labelsL14">14</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>include_right_lbl <span class="deemph">:=</span> true</div></div><div class="locGutter" data-l="15" data-i="3" id="code_include_labelsL15"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="15" href="#code_include_labelsL15">15</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> <span class="deemph">:=</span> <a class="rustic value" data-ref="lbls_max" data-preview-anchor="/bab/previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a></div></div><div class="locGutter" data-l="16" data-i="2" id="code_include_labelsL16"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="16" href="#code_include_labelsL16">16</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><span class="rb0 close">}</span></div></div><div class="locGutter" data-l="17" data-i="2" id="code_include_labelsL17"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="17" href="#code_include_labelsL17">17</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div></div><div class="locGutter" data-l="18" data-i="2" id="code_include_labelsL18"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="18" href="#code_include_labelsL18">18</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div><div class="lineComment">Recursively process the right child with the remaining capacity.</div></div><div class="locGutter" data-l="19" data-i="2" id="code_include_labelsL19"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="19" href="#code_include_labelsL19">19</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><a class="rustic function" data-ref="include_labels" data-preview-anchor="/bab/previews/include_labels.html?def§include_labels" data-hl="true" href="#include_labels">include_labels</a><span class="rb0 open">(</span><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>right<span class="deemph">,</span> <a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbls_max" data-preview-anchor="/bab/previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a><span class="rb0 close">)</span></div></div><div class="locGutter" data-l="20" data-i="1" id="code_include_labelsL20"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="20" href="#code_include_labelsL20">20</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><span class="rb2 close">}</span> <span class="kw">else</span> <span class="rb2 open">{</span></div></div><div class="locGutter" data-l="21" data-i="2" id="code_include_labelsL21"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="21" href="#code_include_labelsL21">21</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div><div class="lineComment">We cannot omit all labels for the left subtree. We include the label of our right child, so that the left subtree becomes verifiable as soon as possible. For our right subtree, we can hence start with full buffer capacity again.</div></div><div class="locGutter" data-l="22" data-i="2" id="code_include_labelsL22"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="22" href="#code_include_labelsL22">22</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>include_right_lbl <span class="deemph">:=</span> true</div></div><div class="locGutter" data-l="23" data-i="2" id="code_include_labelsL23"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="23" href="#code_include_labelsL23">23</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><a class="rustic function" data-ref="include_labels" data-preview-anchor="/bab/previews/include_labels.html?def§include_labels" data-hl="true" href="#include_labels">include_labels</a><span class="rb0 open">(</span><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>right<span class="deemph">,</span> <a class="rustic value" data-ref="lbls_max" data-preview-anchor="/bab/previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbls_max" data-preview-anchor="/bab/previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a><span class="rb0 close">)</span></div></div><div class="locGutter" data-l="24" data-i="2" id="code_include_labelsL24"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="24" href="#code_include_labelsL24">24</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div></div><div class="locGutter" data-l="25" data-i="2" id="code_include_labelsL25"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="25" href="#code_include_labelsL25">25</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div><div class="lineComment">Can we at least skip <em>our</em> left label?</div></div><div class="locGutter" data-l="26" data-i="2" id="code_include_labelsL26"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="26" href="#code_include_labelsL26">26</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><span class="kw">if</span> <a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> &gt;= <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a> <span class="rb0 open">{</span></div></div><div class="locGutter" data-l="27" data-i="3" id="code_include_labelsL27"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="27" href="#code_include_labelsL27">27</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>include_left_lbl <span class="deemph">:=</span> false</div></div><div class="locGutter" data-l="28" data-i="3" id="code_include_labelsL28"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="28" href="#code_include_labelsL28">28</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> <span class="deemph">-=</span> <a class="rustic value" data-ref="width" data-preview-anchor="/bab/previews/width.html?def§width" data-hl="true" href="#width">width</a></div></div><div class="locGutter" data-l="29" data-i="2" id="code_include_labelsL29"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="29" href="#code_include_labelsL29">29</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><span class="rb0 close">}</span> <span class="kw">else</span> <span class="rb0 open">{</span></div></div><div class="locGutter" data-l="30" data-i="3" id="code_include_labelsL30"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="30" href="#code_include_labelsL30">30</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>include_left_lbl <span class="deemph">:=</span> true</div></div><div class="locGutter" data-l="31" data-i="3" id="code_include_labelsL31"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="31" href="#code_include_labelsL31">31</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><div class="indent"> </div><a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a> <span class="deemph">:=</span> <a class="rustic value" data-ref="lbls_max" data-preview-anchor="/bab/previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a></div></div><div class="locGutter" data-l="32" data-i="2" id="code_include_labelsL32"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="32" href="#code_include_labelsL32">32</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><span class="rb0 close">}</span></div></div><div class="locGutter" data-l="33" data-i="2" id="code_include_labelsL33"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="33" href="#code_include_labelsL33">33</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div></div><div class="locGutter" data-l="34" data-i="2" id="code_include_labelsL34"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="34" href="#code_include_labelsL34">34</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div></div><div class="lineComment">Recursively process the left child with the remaining capacity.</div></div><div class="locGutter" data-l="35" data-i="2" id="code_include_labelsL35"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="35" href="#code_include_labelsL35">35</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><div class="indent"> </div><a class="rustic function" data-ref="include_labels" data-preview-anchor="/bab/previews/include_labels.html?def§include_labels" data-hl="true" href="#include_labels">include_labels</a><span class="rb0 open">(</span><a class="rustic value" data-ref="lbls_v" data-preview-anchor="/bab/previews/lbls_v.html?def§lbls_v" data-hl="true" href="#lbls_v">v</a><span class="deemph">.</span>left<span class="deemph">,</span> <a class="rustic value" data-ref="lbls_av" data-preview-anchor="/bab/previews/lbls_av.html?def§lbls_av" data-hl="true" href="#lbls_av">available</a><span class="deemph">,</span> <a class="rustic value" data-ref="lbls_max" data-preview-anchor="/bab/previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a><span class="rb0 close">)</span></div></div><div class="locGutter" data-l="36" data-i="1" id="code_include_labelsL36"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="36" href="#code_include_labelsL36">36</a></div><div class="fold"></div></div><div class="locContent"><div><div class="indent"> </div><span class="rb2 close">}</span></div></div><div class="locGutter" data-l="37" data-i="0" id="code_include_labelsL37"><div class="lineNumber"><a data-pseudocode="code_include_labels" data-ref="code_include_labels" data-hllines="37" href="#code_include_labelsL37">37</a></div><div class="fold"></div></div><div class="locContent"><div><span class="rb1 close">}</span></div></div></code><p><span class="inline" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;margin: 0 0.1em;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj: TODO: example</span></p><p>An interesting special case of <a class="rustic function" data-ref="include_labels" data-preview-anchor="previews/include_labels.html?def§include_labels" data-hl="true" href="#include_labels">include_labels</a> is that of <a class="rustic value" data-ref="lbls_max" data-preview-anchor="previews/lbls_max.html?def§lbls_max" data-hl="true" href="#lbls_max">max</a> being equal to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="enclosing rustic value"><span class="enclosing" data-ref="chunk_size" data-preview-anchor="previews/chunk_size.html?def§chunk_size" data-hl="true"><a href="#chunk_size"><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.03148em;">nk</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mspace" style="margin-right:0.2222em;"></span></a></span></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="enclosing rustic value"><span class="enclosing" data-ref="width" data-preview-anchor="previews/width.html?def§width" data-hl="true"><a href="#width"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></a></span></span><span class="enclosing normalText"><span class="mord text"><span class="mord">.</span></span></span></span></span></span> The function becomes significantly more simple: all right child labels are be emitted, and the left child label of some inner vertex is emitted if and only if the distance between the vertex and its leftmost leaf descendent is one greater than a number divisible by <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3581em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0131em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="enclosing rustic value mtight"><span class="enclosing mtight" data-ref="width" data-preview-anchor="previews/width.html?def§width" data-hl="true"><a class="mtight" href="#width"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">h</span></a></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.527em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="enclosing rustic value mtight"><span class="enclosing mtight" data-ref="chunk_size" data-preview-anchor="previews/chunk_size.html?def§chunk_size" data-hl="true"><a class="mtight" href="#chunk_size"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">nk</span><span class="mord mtight" style="margin-right:0.02778em;">_</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">ze</span></a></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="enclosing normalText"><span class="mord text"><span class="mord">.</span></span></span></span></span></span></p><p><span class="inline" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;margin: 0 0.1em;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj: TODO: example</span></p><p>Given the existence of such special cases, it can make sense to statically specify a buffering capacity for all participants in a system, and then apply that capacity to all requests, as described next.</p></section><h3 id="sec_static_streaming"><a class="hsection" data-ref="sec_static_streaming" data-hl="true" data-hsection-level="2" href="#sec_static_streaming">3.5 Static Get Requests</a></h3><section data-hsection="sec_static_streaming"><p>A <dfn id="static_streaming_get"><a class="rustic type" data-ref="static_streaming_get" data-preview-anchor="/bab/previews/static_streaming_get.html?def§static_streaming_get" data-hl="true" href="#static_streaming_get">StaticStreamingGet</a></dfn> request consists of a single Bab digest, and the valid responses are exactly those of a <a class="rustic type" data-ref="dynamic_streaming_get" data-preview-anchor="/bab/previews/dynamic_streaming_get.html?def§dynamic_streaming_get" data-hl="true" href="#dynamic_streaming_get">DynamicStreamingGet</a> for the same digest and some statically fixed, well-known buffer capacity.</p><p>If the only <code>get</code> requests in a system are <a class="rustic type" data-ref="static_streaming_get" data-preview-anchor="previews/static_streaming_get.html?def§static_streaming_get" data-hl="true" href="#static_streaming_get">StaticStreamingGet</a> requests, then participants know in advance which tree labels will never be sent. They can forego storing those labels altogether, without loosing any performance.</p></section><h3 id="sec_simple_slice"><a class="hsection" data-ref="sec_simple_slice" data-hl="true" data-hsection-level="2" href="#sec_simple_slice">3.6 Simple Slice Requests</a></h3><section data-hsection="sec_simple_slice"><p>Beyond verified streaming of full strings, the Merkle tree also enables verified srteaming of arbitrary slices. To introduce slice requests, we ignore buffering optimizations for a bit.</p><p>A <dfn id="simple_slice"><a class="rustic type" data-ref="simple_slice" data-preview-anchor="/bab/previews/simple_slice.html?def§simple_slice" data-hl="true" href="#simple_slice">SimpleSlice</a></dfn> request consists of a Bab digest, the offset of the first chunk to request (an unsigned 64-bit integer), and the number of chunks in the slice (a natural number between <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, both inclusive). It asks for the corresponding substring of a string that hashes to the given digest, as well as interleaved verification metadata that allows verifying that the stream of incoming string data does indeed belong to that string.</p><p>There are three possible responses. First, the server can indicate that it does not have the requested data. Second, it can indicate that the slice is invalid (the sum of the offset and the length is greater than the length of the string divided by <a class="rustic value" data-ref="chunk_size" data-preview-anchor="/bab/previews/chunk_size.html?def§chunk_size" data-hl="true" href="#chunk_size">chunk_size</a>), in which case the response is identical to a successful response to a <a class="rustic type" data-ref="length" data-preview-anchor="/bab/previews/length.html?def§length" data-hl="true" href="#length">Length</a> request. If neither of these is the case, then the response consists of chunk data and verification metadata. The data to transmit is identical to that of a successful response to a <a class="rustic type" data-ref="simple_streaming_get" data-preview-anchor="/bab/previews/simple_streaming_get.html?def§simple_streaming_get" data-hl="true" href="#simple_streaming_get">SimpleStreamingGet</a> request, except that all metadata emitted by a Merkle tree node that does not lie on a path from the root to any of the chunks in the slice is omitted.</p><p><span class="inline" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;margin: 0 0.1em;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj: TODO: example</span></p><p>When a client makes a slice request in a string for which it has already made prior slice requests, then the verification metadata of those old requests might overlap with the verification metadata for the new request. Ideally, the client should be able to compactly communicate already-available metadata to the server, so that it can be omitted from the response.</p><p>The metadata for any request consist of the inner nodes on all paths from the root to the requested chunks. Hence, the metadata for two non-overlapping chunks might overlap towards the root of the tree, but diverges towards the leaves (see <a href="#">invalid-reference</a>). This enables the client to compactly communicate which data the server can skip: for the paths from the root to the leftmost and rightmost chunk of the requested slice respectively, the client can supply the number of vertices whose emitted metadata to omit.</p></section><h3 id="sec_pruned_slice"><a class="hsection" data-ref="sec_pruned_slice" data-hl="true" data-hsection-level="2" href="#sec_pruned_slice">3.7 Pruned Slice Requests</a></h3><section data-hsection="sec_pruned_slice"><p>A <dfn id="pruned_slice"><a class="rustic type" data-ref="pruned_slice" data-preview-anchor="/bab/previews/pruned_slice.html?def§pruned_slice" data-hl="true" href="#pruned_slice">PrunedSlice</a></dfn> request consists of a Bab digest, the offset of the first chunk to request (an unsigned 64-bit integer), the number of chunks in the slice (a natural number between <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, both inclusive), a number of vertices to skip on the path from the root to the first requested chunk (between 0 and 64), and a number of vertices to skip on the path from the root to the final requested chunk (between 0 and 64). It asks for the corresponding substring of a string that hashes to the given digest, as well as interleaved verification metadata that allows verifying that the stream of incoming string data does indeed belong to that string, assuming that the metadata for the indicated vertices is already available.</p><p>The response options to a <a class="rustic type" data-ref="pruned_slice" data-preview-anchor="/bab/previews/pruned_slice.html?def§pruned_slice" data-hl="true" href="#pruned_slice">PrunedSlice</a> request are those of the response options to the corresponding <a class="rustic type" data-ref="simple_slice" data-preview-anchor="/bab/previews/simple_slice.html?def§simple_slice" data-hl="true" href="#simple_slice">SimpleSlice</a> request, except in a successful response, all the metadata emitted by any vertex that is amongst the first indicated vertices on the path from the root to either the first or the final chunk is omitted.<span class="marginale"><span class="" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj: TODO: improve the wording. Give names to the offsets to skip.</span></span></p><p><span class="inline" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;margin: 0 0.1em;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj: TODO: example</span></p></section><h3 id="sec_dynamic_slice"><a class="hsection" data-ref="sec_dynamic_slice" data-hl="true" data-hsection-level="2" href="#sec_dynamic_slice">3.8 Dynamic Pruned Slice Requests</a></h3><section data-hsection="sec_dynamic_slice"><p>A <dfn id="dynamic_pruned_slice"><a class="rustic type" data-ref="dynamic_pruned_slice" data-preview-anchor="/bab/previews/dynamic_pruned_slice.html?def§dynamic_pruned_slice" data-hl="true" href="#dynamic_pruned_slice">DynamicPrunedSlice</a></dfn> requests combine pruned slice requests with a dynamically supplied amount of buffer space for unverified data. Determining which metadata to skip requires its own algorithm, modified from <a class="rustic function" data-ref="include_labels" data-preview-anchor="/bab/previews/include_labels.html?def§include_labels" data-hl="true" href="#include_labels">include_labels</a>.<span class="inline" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;margin: 0 0.1em;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj:  TODO properly write this section, write down the algorithm.</span></p><p>Note that the <a class="rustic type" data-ref="dynamic_pruned_slice" data-preview-anchor="previews/dynamic_pruned_slice.html?def§dynamic_pruned_slice" data-hl="true" href="#dynamic_pruned_slice">DynamicPrunedSlice</a> are expressive enough to encompass every single type of request we have defined.</p></section><h3 id="sec_static_slice"><a class="hsection" data-ref="sec_static_slice" data-hl="true" data-hsection-level="2" href="#sec_static_slice">3.9 Static Pruned Slice Requests</a></h3><section data-hsection="sec_static_slice"><p><span class="inline" style="font-family: var(--font-mono); font-size: 0.85em; color: #6804cc; background-color: #ecdbfc;margin: 0 0.1em;;padding: 0.2em 0.1em;border-radius: 4px;box-decoration-break: clone;">alj: TODO: write this</span></p></section></section><h2 id="bibliography"><a class="hsection" data-ref="bibliography" data-hl="true" data-hsection-level="1" href="#bibliography">References</a></h2><section data-hsection="bibliography"><div class="csl-bib-body hangingindent"><div id="tamassia2003authenticated"><a data-ref="tamassia2003authenticated" href="assets/references/tamassia2003authenticated.pdf">  <span style="font-variant:small-caps;">Tamassia, Roberto</span>: Authenticated data structures. In: <i>Algorithms-ESA 2003: 11th Annual European Symposium, Budapest, Hungary, September 16-19, 2003. Proceedings 11</i> : Springer, 2003, pp. 2–5</a></div></div></section></section></div></body></html>